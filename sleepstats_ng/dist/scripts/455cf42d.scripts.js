"use strict";function generateChartData(a,b,c,d){return{chart:{renderTo:"container",defaultSeriesType:"column",backgroundColor:"#eee",borderWidth:1,borderColor:"#ccc",plotBackgroundColor:"#fff",plotBorderWidth:1,plotBorderColor:"#ccc"},credits:{enabled:!1},exporting:{enabled:!1},title:{text:a},legend:{},tooltip:{borderWidth:1,formatter:function(){return"<b>Minutes:</b><br/> "+this.x+"<br/>"+"<b>Count:</b> "+this.y}},plotOptions:{column:{shadow:!1,borderWidth:.5,borderColor:"#666",pointPadding:0,groupPadding:0,color:"rgba(204,204,204,.85)"},spline:{shadow:!1,marker:{radius:1}},areaspline:{color:"rgb(69, 114, 167)",fillColor:"rgba(69, 114, 167,.25)",shadow:!1,marker:{radius:1}}},xAxis:{categories:b,labels:{rotation:-90,y:40,style:{fontSize:"8px",fontWeight:"normal",color:"#333"}},lineWidth:0,lineColor:"#999",tickLength:70,tickColor:"#ccc"},yAxis:{title:{text:""},gridLineColor:"#e9e9e9",tickWidth:1,tickLength:3,tickColor:"#ccc",lineColor:"#ccc",tickInterval:d},series:[{name:"Bins",data:c},{name:"Curve",type:"spline",visible:!1,data:c},{name:"Filled Curve",type:"areaspline",visible:!1,data:c}]}}function timeSeriesToDistribution(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;for(c=_.groupBy(a,function(a){return a.value}),c=_.sortBy(c,function(a){return parseInt(a[0].value,10)}),d=_.map(c,function(a){return parseInt(a[0].value,10)}),e=_.map(c,function(a){return a.length}),f=_.min(d),g=_.max(d),h={},i=g-f,j=1>i/b?1:Math.floor((g-f)/b)+1,k=0;j>k;k++)for(m=f+b*k,n=m+b-1,o=m+"-"+n,h[o]=0,l=0;l<d.length;l++)d[l]>=m&&d[l]<=n&&(h[o]+=e[l]);return h=_.sortBy(_.pairs(h),function(a){return parseInt(a[0].match(/^(\d+)-/)[1],10)}),d=_.map(h,function(a){return a[0]}),e=_.map(h,function(a){return a[1]}),[d,e]}function showChart(a,b,c,d,e){var f,g,h,i;g=timeSeriesToDistribution(c,e),h=g[0],i=g[1],f=generateChartData(d,h,i,1),$(b).highcharts(f)}angular.module("sleepstatsApp",[]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/stats.html",controller:"StatsCtrl"}).otherwise({redirectTo:"/"})}]).value("apis",{urls:{fitbit:{sleepAwakenings:"/fitbit/sleepAwakenings/2013-05-04/2013-08-04",sleepTimeToSleep:"/fitbit/sleepTimeToSleep/2013-05-04/2013-08-04",sleepTimeInBed:"/fitbit/sleepTimeInBed/2013-05-04/2013-08-04",auth:"/fitbit/authorize"}}}),angular.module("sleepstatsApp").controller("StatsCtrl",["$scope","$http","$q","apis","$window",function(a,b,c,d,e){c.all([b.get(d.urls.fitbit.sleepAwakenings),b.get(d.urls.fitbit.sleepTimeToSleep),b.get(d.urls.fitbit.sleepTimeInBed)]).then(function(b){a.awakenings=b[0].data["sleep-awakeningsCount"],a.timeToSleep=b[1].data["sleep-minutesToFallAsleep"],a.timeInBed=b[2].data["sleep-timeInBed"],a.dataLoaded=!0},function(a){a.status&&401===a.status&&(e.location.href=d.urls.fitbit.auth)}),a.dataLoaded=!1,a.graphType="awakenings",a.showGraph=function(b){a.graphType=b}}]),angular.module("sleepstatsApp").directive("highchart",function(){return{template:"<div></div>",restrict:"A",link:function(a,b,c){var d;d=a[c.highchart],d&&showChart(c.highchart,b,d,c.title,parseInt(c.bucketsize,10))}}});